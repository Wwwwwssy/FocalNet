description: train clip model on google cc and sbu

target:
  service: sing
  name: cogs-sing-shared-wu3

environment:
  registry: ptebic.azurecr.io
  image: public/azureml/aifx/stable-ubuntu2004-cu115-py38-torch1110:20220725  
  setup:
  - pip install --upgrade pip  
  - pip install git+https://github.com/huggingface/transformers.git --user
  - pip install sentencepiece --user
  - pip install -r requirements.txt --user

storage:
  test_data_storage:
    storage_account_name: vlpdatasets
    container_name: data
  model_storage:
    storage_account_name: projects4jw
    container_name: amulet

code:
  # local directory of the code. this will be uploaded to the server.
  # $CONFIG_DIR is expanded to the directory of this config file
  local_dir: ./

search:
  job_template:
    name: train_focalnet
    mpi: True
    sku: 4xG8
    process_count_per_node: 1
    command:
    - ulimit -n 4096
    - pip install timm==0.4.12 antialiased-cnns bcolz ftfy regex tqdm einops ptflops
    - pip install opencv-python==4.4.0.46 termcolor==1.1.0 yacs==0.1.8
    - export MKL_SERVICE_FORCE_INTEL=1
    - MKL_THREADING_LAYER=GNU python -m launch --nnodes={nnodes} --nproc_per_node={ngpus} --master_port 12345 main_llm.py 
      --data-path /mnt/test_data_storage/imagenet_zip/2012
      --zip 
      --batch-size {batch_size}
      --cfg configs/{config}.yaml 
    submit_args:
      container_args:
        shm_size: 2048g
  max_trials: 36
  type: grid          
  params:
    - name: nnodes
      spec: discrete
      values: [4]
    - name: ngpus
      spec: discrete
      values: [8]  
    - name: batch_size
      spec: discrete
      values: [32]
    - name: config
      spec: discrete
      values: [
        'focalnet_tiny_srf_llm', 
      ]      