description: train clip model on google cc and sbu

target:
  service: amlk8s
  name: itphyperdgx2cl1
  vc: hai2
  # name: itplabrr1cl1
  # vc: mprr4

environment:
  registry: docker.io
  image: leoxiao/pytorch:ubuntu18.04_torch1.9-cuda11.2-nccl_bootstrap_tag-deepspeed0.4.5
  # image: leoxiao/pytorch:ubuntu18.04_torch1.9-cuda10.2-nccl_bootstrap_tag-deepspeed0.4.5
  # image: amsword/setup:py36pt17u18cu11
  # image: kevinlin311tw/mesh:py38-cuda11.4-torch1.10.0
  # image: pengchuanzhang/maskrcnn:ubuntu18-py3.7-cuda10.1-pytorch1.7
  # image: wangkenpu/pytorch:1.8.0-py39-cuda11.1-cudnn8-ubuntu18.04
  setup:
  - pip install torchvision==0.10.0 --user
  - pip install git+https://github.com/huggingface/transformers.git --user
  - pip install sentencepiece --user
  - pip install -r requirements.txt --user
  - wget https://github.com/microsoft/FocalNet/releases/download/v1.0.0/focalnet_tiny_srf.pth
  # - ./azcopy/azcopy cp "https://vlpdatasets.blob.core.windows.net/data/imagenet_zip?sv=2021-10-04&ss=btqf&srt=sco&st=2023-04-04T06%3A21%3A00Z&se=2023-05-05T06%3A21%3A00Z&sp=rl&sig=eWQuFwXjN%2FX0%2FKRMtzbA%2BzWBKFfD6SyjXbb%2BVq58ZDE%3D" /tmp/datasets --recursive


storage:
  test_data_storage:
    storage_account_name: vlpdatasets
    container_name: data
  model_storage:
    storage_account_name: projects4jw
    container_name: amulet

code:
  # local directory of the code. this will be uploaded to the server.
  # $CONFIG_DIR is expanded to the directory of this config file
  local_dir: ./

search:
  job_template:
    name: train_focalnet
    mpi: True
    sku: 2xG16
    process_count_per_node: 1
    command:
    - ulimit -n 4096
    - pip install timm==0.4.12 antialiased-cnns ftfy regex tqdm einops ptflops
    - pip install opencv-python==4.4.0.46 termcolor==1.1.0 yacs==0.1.8
    - python -m launch --nnodes={nnodes} --nproc_per_node={ngpus} --master_port 12345 main_llm.py 
      --data-path /mnt/test_data_storage/imagenet_zip/2012
      --zip
      --batch-size {batch_size}
      --cfg configs/{config}.yaml 
      --resume ./focalnet_tiny_srf.pth
    submit_args:
      container_args:
        shm_size: 2048g
  max_trials: 36
  type: grid          
  params:
    - name: nnodes
      spec: discrete
      values: [2]
    - name: ngpus
      spec: discrete
      values: [16]  
    - name: batch_size
      spec: discrete
      values: [32]
    - name: config
      spec: discrete
      values: [
        'focalnet_tiny_srf_llm', 
      ]      